---
- hosts: localhost
  connection: local
  become: true

  tasks:
  - name: Create the `aur_builder` user
    become: yes
    ansible.builtin.user:
      name: aur_builder
      create_home: yes
      group: wheel
      state: present

  - name: Allow the `aur_builder` user to run `sudo pacman` without a password
    become: yes
    ansible.builtin.lineinfile:
      path: /etc/sudoers.d/11-install-aur_builder
      line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
      create: yes
      validate: 'visudo -cf %s'

  # Note: Dependency resolution will still include repository packages.
  - name: Upgrade the system using yay.
    kewlfft.aur.aur:
      upgrade: yes
      use: yay
      aur_only: no
    become: yes
    become_user: aur_builder

  - name: Install packages using yay
    kewlfft.aur.aur:
      use: yay
      name:
        - aur/dmenu2
        - aur/docker-credential-pass-bin
        - aur/etcher-bin
        - aur/flux-bin
        - aur/google-chrome
        - aur/google-cloud-sdk
        - aur/go-task-bin
        - aur/i3blocks-contrib
        - aur/kind-bin
        - aur/kubeseal-bin
        - aur/lens-bin
        - aur/mqtt-explorer-appimage
        - aur/nerd-fonts-inconsolata
        - aur/nerd-fonts-inconsolata-go
        - aur/nodejs-markdownlint-cli
        - aur/nvm
        - aur/otf-inconsolata-dz-powerline
        - aur/postman-bin
        - aur/pyenv-virtualenv
        - aur/spaceship-prompt
        - aur/spotify
        - aur/terraform-docs-bin
        - aur/tflint-bin
        - aur/tfsec
        - aur/visual-studio-code-bin
        - aur/yay
      state: latest
    become: yes
    become_user: aur_builder


  - name: create symlink for go-task
    ansible.builtin.file:
      src: /usr/bin/go-task
      dest: /usr/bin/task
      state: link
    become: yes


  - name: install packages
    ansible.builtin.package:
      name:
        - community/zsh-syntax-highlighting
        - community/zsh-autosuggestions
        - community/yq
        - community/yarn
        - community/yamllint
        - community/x11-ssh-askpass
        - community/vault
        - community/ttf-liberation
        - community/ttf-font-awesome
        - community/ttf-fira-code
        - community/ttf-dejavu
        - community/tmux
        - community/tig
        - community/terraform
        - community/sops
        - community/semver
        - community/scrot
        - community/redis
        - community/ranger
        - community/pyenv
        - community/prettier
        - community/pacman-contrib
        - community/openbsd-netcat
        - community/nodejs
        - community/neovim
        - community/kustomize
        - community/kubectl
        - community/k9s
        - community/jq
        - community/iotop
        - community/iftop
        - community/i3status
        - community/i3lock
        - community/i3blocks
        - community/i3-gaps
        - community/helm
        - community/go
        - community/dunst
        - community/docker-compose
        - community/docker
        - community/discord
        - community/direnv
        - community/colordiff
        - community/barrier
        - community/ansible
        - community/alacritty
        - community/acpi

      state: latest
    become: yes

  # - name: copy wallpaper file
  #   copy:
  #     src: files/wallpaper.png
  #     dest: /usr/share/backgrounds/ansible-wallpaper.png
  #     owner: root
  #     group: root

  # - name: set wallpaper
  #   become_user: jay
  #   dconf:
  #     key: "/org/gnome/desktop/background/picture-uri"
  #     value: "'file:///usr/share/backgrounds/ansible-wallpaper.png'"

  # - name: set wallpaper position
  #   become_user: jay
  #   dconf:
  #     key: "/org/gnome/desktop/background/picture-options"
  #     value: "'zoom'"

  # - name: copy .bashrc file
  #   copy:
  #    src: files/bashrc
  #    dest: /home/jay/.bashrc
  #    owner: jay
  #    group: jay

  # - name: add ansible user
  #   user:
  #     name: velociraptor
  #     system: yes

  # - name: set up sudo for ansible user
  #   copy:
  #     src: files/sudoer_velociraptor
  #     dest: /etc/sudoers.d/velociraptor
  #     owner: root
  #     group: root
  #     mode: 0440

  # - name: add ansible-pull cron job
  #   cron:
  #     name: ansible auto-provision
  #     user: velociraptor
  #     minute: "*/10"
  #     job: ansible-pull -o -U https://github.com/jlacroix82/ansible_pull_tutorial.git
